#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "Exécution des tests unitaires avant le push..."

# Utiliser git diff avec des guillemets pour éviter les problèmes de chemins Windows
CHANGED_FILES=$(git diff --name-only --cached | grep -E "\.(ts|js)$" | grep -v "\.spec\.ts$" | grep -v "\.test\.ts$")

if [ -n "$CHANGED_FILES" ]; then
    # Créer un fichier temporaire pour stocker la liste (évite les problèmes de formatage en ligne)
    TEMP_FILE=$(mktemp)
    echo "$CHANGED_FILES" >"$TEMP_FILE"

    # Si Jest est utilisé et supporte --findRelatedTests
    if pnpm test:unit --help 2>&1 | grep -q "findRelatedTests"; then
        echo "Exécution des tests uniquement pour les fichiers modifiés"
        # Utiliser cat au lieu de echo pour éviter les problèmes d'interprétation
        cat "$TEMP_FILE" | xargs -r pnpm test:unit --findRelatedTests
    else
        # Sinon, exécuter tous les tests unitaires
        echo "Exécution de tous les tests unitaires"
        pnpm test:unit
    fi

    # Nettoyer le fichier temporaire
    rm -f "$TEMP_FILE"
else
    echo "Aucun fichier modifié nécessitant des tests"
fi
